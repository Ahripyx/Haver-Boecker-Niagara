@model Haver_Boecker_Niagara.Models.GanttSchedule

@{
    ViewData["Title"] = "Gantt Schedule Details";
}

<h1>Gantt Schedule Details</h1>
<hr />
<div class="p-4 shadow-sm card-container mb-3">
    <div class="row">
        <div class="col-md-6">
            <dl class="column">
                <dt>Order Number</dt>
                <dd>@Model.SalesOrder.OrderNumber</dd>
            </dl>
        </div>
        <div class="col-md-6">
            <dl class="column">
                <dt>Customer</dt>
                <dd>@(Model.SalesOrder.Customer?.Name ?? "N/A")</dd>
            </dl>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <dl class="column">
                <dt>Engineer Initials</dt>
                <dd>@string.Join(", ", Model.SalesOrder.EngineeringPackage.Engineers.Select(e => e.Initials))</dd>
            </dl>
        </div>
    </div>
</div>

<div class="p-4 shadow-sm card-container mb-3">
    <h4>Schedule Details</h4>
    <hr />
    <div class="timeline">
        <div class="timeline-item">
            <div class="milestone-dot"></div>
            <div class="timeline-content">
                <strong>Pre-Orders Expected:</strong> @Model.PreOrdersExpected?.ToString("dddd, MMM dd yyyy")"
            </div>
        </div>
        <div class="timeline-item">
            <div class="milestone-dot"></div>
            <div class="timeline-content">
                <strong>Readiness to Ship Expected:</strong> @Model.ReadinessToShipExpected?.ToString("dddd, MMM dd yyyy")"
            </div>
        </div>
        <div class="timeline-item">
            <div class="milestone-dot"></div>
            <div class="timeline-content">
                <strong>Promise Date:</strong> @Model.PromiseDate.ToString("dddd, MMM dd yyyy")
            </div>
        </div>
        <div class="timeline-item">
            <div class="milestone-dot"></div>
            <div class="timeline-content">
                <strong>Deadline Date:</strong> @Model.DeadlineDate?.ToString("dddd, MMM dd yyyy")"
            </div>
        </div>
</div>
</div>
<div class="p-4 shadow-sm card-container mb-3">
    <h4>Milestone Progress</h4>
    <hr />
    @{
        var validMilestones = Model.EngineeringOnly
        ? Model.KickoffMeetings?.SelectMany(k => k.Milestones).Where(m => m.Name == Haver_Boecker_Niagara.Models.Task.EngineeringReleased).ToList()
        : Model.KickoffMeetings?.SelectMany(k => k.Milestones).Where(m =>
        new List<Haver_Boecker_Niagara.Models.Task>
            {
        Haver_Boecker_Niagara.Models.Task.PurchaseOrdersIssued,
        Haver_Boecker_Niagara.Models.Task.ApprovalDrawing,
        Haver_Boecker_Niagara.Models.Task.PackageReleased,
        Haver_Boecker_Niagara.Models.Task.MachineAssembly,
        Haver_Boecker_Niagara.Models.Task.MachineTesting,
        Haver_Boecker_Niagara.Models.Task.EngineeringReleased
            }.Contains(m.Name)).ToList();

        var milestoneStatuses = validMilestones?.ToDictionary(m => m.Name, m => m.Status) ?? new Dictionary<Haver_Boecker_Niagara.Models.Task, Haver_Boecker_Niagara.Models.Status>();
        var totalMilestones = validMilestones?.Count ?? 0;
        var completedMilestones = validMilestones?.Count(m => m.Status == Haver_Boecker_Niagara.Models.Status.Closed) ?? 0;
        var progressPercentage = totalMilestones > 0 ? (completedMilestones * 100) / totalMilestones : 0;
    }
    <div class="progress-line">
        @foreach (var milestone in validMilestones ?? new List<Haver_Boecker_Niagara.Models.Milestone>())
        {
            var isCompleted = milestone.Status == Haver_Boecker_Niagara.Models.Status.Closed;
            <div class="milestone-dot @(isCompleted ? "completed" : "pending")" title="@milestone.Name"></div>
        }
        <div class="timeline">

                <div class="timeline-item">
                    <div class="timeline-dot milestone-dot @(ViewData["MilestoneStatus"] != null && (Status)ViewData["MilestoneStatus"] == Status.Open ? "status-open" : "status-closed")">
                    </div>
                    <div class="timeline-content">
                        <strong>Latest Milestone:</strong> @Model.LatestMilestone
                    </div>
                </div>
        </div>
    </div>
        </div>



@if (!Model.EngineeringOnly)
{
    <div class="p-4 shadow-sm card-container mb-3">
        <h4>Machine Details</h4>
        <hr />
        <div class="row">
            <div class="col-md-6">
                <dl class="column">
                    <dt>Machine Description</dt>
                    <dd>@Model.SalesOrder.Machines.FirstOrDefault(m => m.MachineID == Model.MachineID)?.MachineDescription</dd>
                </dl>
            </div>
            <div class="col-md-6">
                <dl class="column">
                    <dt>Media</dt>
                    <dd>@Model.SalesOrder.Machines.FirstOrDefault(m => m.MachineID == Model.MachineID)?.Media</dd>
                </dl>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <dl class="column">
                    <dt>Spare Parts</dt>
                    <dd>@Model.SalesOrder.Machines.FirstOrDefault(m => m.MachineID == Model.MachineID)?.SparePartsMedia</dd>
                </dl>
            </div>
        </div>
    </div>
}
else
{
    <div class="p-4 shadow-sm card-container mb-3">
        <h4>Engineering Only</h4>
        <p>This schedule is for engineering purposes only and is not linked to a specific machine.</p>
    </div>
}

<div class="d-flex justify-content-end gap-2 mt-4">
    <a asp-action="Index" class="btn-primary-close">Close</a>
    <a asp-action="Edit" asp-route-id="@Model?.GanttID" class="btn-edit">Edit</a>
</div>